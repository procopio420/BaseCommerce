name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      target:
        description: 'Deploy target (all, edge, platform, vertical)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - edge
          - platform
          - vertical
      vertical_name:
        description: 'Vertical name (if target is vertical)'
        required: false
        default: 'construction'
        type: string
      tag:
        description: 'Image tag (optional, defaults to commit SHA)'
        required: false
        default: ''
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        service:
          - name: auth
            dockerfile: apps/auth/Dockerfile
            context: .
          - name: outbox-relay
            dockerfile: apps/outbox-relay/Dockerfile
            context: .
          - name: engines-worker
            dockerfile: apps/engines/Dockerfile
            context: .
          - name: construction
            dockerfile: apps/verticals/construction/Dockerfile
            context: .
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/procopio420/basecommerce/${{ matrix.service.name }}
          tags: |
            type=sha,prefix=sha-,format=short
            type=raw,value=latest-production
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image tags
        run: |
          echo "Built images:"
          echo "${{ steps.meta.outputs.tags }}" | tr ' ' '\n'
  
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.target != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install CLI
        run: |
          python -m pip install --upgrade pip
          pip install -e infra/cli
      
      - name: Setup SSH deploy key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > infra/deploy_key
          chmod 600 infra/deploy_key
          # Configure SSH to accept new hosts automatically (CI environment)
          echo "StrictHostKeyChecking accept-new" >> ~/.ssh/config
      
      - name: Get commit SHA (short)
        id: sha
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Determine deploy tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=sha-${{ steps.sha.outputs.sha }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Determine deploy target
        id: target
        run: |
          if [ -n "${{ github.event.inputs.target }}" ]; then
            echo "target=${{ github.event.inputs.target }}" >> $GITHUB_OUTPUT
          else
            echo "target=all" >> $GITHUB_OUTPUT
          fi
      
      - name: Get previous tag for rollback
        id: previous_tag
        run: |
          # Try to get previous tag from first droplet's deploy history
          # This is a best-effort attempt; rollback will handle missing history
          echo "previous=previous" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Status before deploy
        run: |
          basec status --env production || true
      
      - name: Deploy
        id: deploy_step
        run: |
          TARGET="${{ steps.target.outputs.target }}"
          TAG="${{ steps.tag.outputs.tag }}"
          
          if [ "$TARGET" = "vertical" ]; then
            VERTICAL="${{ github.event.inputs.vertical_name }}"
            basec deploy vertical --vertical "$VERTICAL" --env production --tag "$TAG"
          elif [ "$TARGET" = "all" ]; then
            basec deploy all --env production --tag "$TAG"
          else
            basec deploy "$TARGET" --env production --tag "$TAG"
          fi
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      
      - name: Status after deploy
        run: |
          basec status --env production || true
      
      - name: Smoke tests
        id: smoke_tests
        run: |
          TARGET="${{ steps.target.outputs.target }}"
          
          if [ "$TARGET" = "vertical" ]; then
            VERTICAL="${{ github.event.inputs.vertical_name }}"
            basec smoke vertical --vertical "$VERTICAL" --env production
          elif [ "$TARGET" = "all" ]; then
            basec smoke --env production
          else
            basec smoke "$TARGET" --env production
          fi
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        continue-on-error: true
      
      - name: Rollback on smoke test failure
        if: failure() && steps.smoke_tests.outcome == 'failure'
        run: |
          echo "Smoke tests failed! Rolling back to previous version..."
          TARGET="${{ steps.target.outputs.target }}"
          
          if [ "$TARGET" = "vertical" ]; then
            VERTICAL="${{ github.event.inputs.vertical_name }}"
            basec rollback vertical --vertical "$VERTICAL" --env production --to previous || echo "Rollback failed, manual intervention required"
          elif [ "$TARGET" = "all" ]; then
            basec rollback all --env production --to previous || echo "Rollback failed, manual intervention required"
          else
            basec rollback "$TARGET" --env production --to previous || echo "Rollback failed, manual intervention required"
          fi
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      
      - name: Fail if smoke tests failed
        if: failure() && steps.smoke_tests.outcome == 'failure'
        run: |
          echo "Deployment failed smoke tests and rollback was attempted"
          exit 1

