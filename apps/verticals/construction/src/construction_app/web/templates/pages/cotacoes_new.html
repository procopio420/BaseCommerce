{% extends "layout.html" %}

{% block title %}Nova Cotação - {{ tenant_name }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Nova Cotação</h1>
        <p class="mt-1 text-sm text-gray-500">Preencha as informações para criar um novo orçamento</p>
    </div>

    <!-- Progress Steps -->
    <div class="mb-8">
        <div class="flex items-center">
            <div class="flex items-center {% if step >= 1 %}text-primary{% else %}text-gray-400{% endif %}">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border-2 {% if step >= 1 %}border-primary bg-primary text-white{% else %}border-gray-300{% endif %}">
                    {% if step > 1 %}✓{% else %}1{% endif %}
                </div>
                <span class="ml-2 text-sm font-medium">Cliente/Obra</span>
            </div>
            <div class="flex-1 h-0.5 mx-4 {% if step >= 2 %}bg-primary{% else %}bg-gray-300{% endif %}"></div>
            <div class="flex items-center {% if step >= 2 %}text-primary{% else %}text-gray-400{% endif %}">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border-2 {% if step >= 2 %}border-primary bg-primary text-white{% else %}border-gray-300{% endif %}">
                    {% if step > 2 %}✓{% else %}2{% endif %}
                </div>
                <span class="ml-2 text-sm font-medium">Itens</span>
            </div>
            <div class="flex-1 h-0.5 mx-4 {% if step >= 3 %}bg-primary{% else %}bg-gray-300{% endif %}"></div>
            <div class="flex items-center {% if step >= 3 %}text-primary{% else %}text-gray-400{% endif %}">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border-2 {% if step >= 3 %}border-primary bg-primary text-white{% else %}border-gray-300{% endif %}">
                    {% if step > 3 %}✓{% else %}3{% endif %}
                </div>
                <span class="ml-2 text-sm font-medium">Descontos</span>
            </div>
            <div class="flex-1 h-0.5 mx-4 {% if step >= 4 %}bg-primary{% else %}bg-gray-300{% endif %}"></div>
            <div class="flex items-center {% if step >= 4 %}text-primary{% else %}text-gray-400{% endif %}">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border-2 {% if step >= 4 %}border-primary bg-primary text-white{% else %}border-gray-300{% endif %}">
                    4
                </div>
                <span class="ml-2 text-sm font-medium">Revisão</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                {% if step == 1 %}
                <!-- Step 1: Cliente/Obra -->
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Cliente e Obra</h2>
                <form method="POST" action="/web/cotacoes/new/step1" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cliente *</label>
                        <select name="cliente_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione um cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" {% if wizard_state.cliente_id == cliente.id|string %}selected{% endif %}>{{ cliente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Obra (opcional)</label>
                        <select name="obra_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Nenhuma obra</option>
                            {% for obra in obras %}
                            <option value="{{ obra.id }}" {% if wizard_state.obra_id == obra.id|string %}selected{% endif %}>{{ obra.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">
                            Próximo →
                        </button>
                    </div>
                </form>
                {% elif step == 2 %}
                <!-- Step 2: Itens -->
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Adicionar Itens</h2>
                <div class="mb-4">
                    <input type="text" name="q" placeholder="Buscar produto..." 
                           hx-get="/web/cotacoes/new/search-products" 
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#product-results"
                           hx-include="[name='q']"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    <div id="product-results" class="mt-2"></div>
                </div>
                {% include "partials/cotacao_cart_items.html" %}
                <div class="flex justify-between mt-4">
                    <a href="/web/cotacoes/new?step=1" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                        ← Anterior
                    </a>
                    <a href="/web/cotacoes/new?step=3" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">
                        Próximo →
                    </a>
                </div>
                {% elif step == 3 %}
                <!-- Step 3: Descontos -->
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Descontos e Observações</h2>
                <form method="POST" action="/web/cotacoes/new/step3" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Desconto Percentual</label>
                        <input type="number" name="desconto_percentual" step="0.01" min="0" max="100" 
                               value="{{ wizard_state.desconto_percentual if wizard_state.desconto_percentual else 0 }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                        <textarea name="observacoes" rows="4" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">{{ wizard_state.observacoes or '' }}</textarea>
                    </div>
                    <div class="flex justify-between">
                        <a href="/web/cotacoes/new?step=2" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                            ← Anterior
                        </a>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">
                            Próximo →
                        </button>
                    </div>
                </form>
                {% elif step == 4 %}
                <!-- Step 4: Revisão -->
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Revisão Final</h2>
                <div class="space-y-4">
                    <!-- TODO: Mostrar resumo completo -->
                    <div class="bg-gray-50 p-4 rounded-md">
                        <h3 class="font-medium text-gray-900 mb-2">Resumo</h3>
                        <p class="text-sm text-gray-600">Cliente: <span id="review-cliente">-</span></p>
                        <p class="text-sm text-gray-600">Total: <span id="review-total">R$ 0,00</span></p>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button hx-get="/web/cotacoes/new?step=3" hx-target="#wizard-content" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                        ← Anterior
                    </button>
                    <button hx-post="/web/cotacoes/new/finalize" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Finalizar e Enviar
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar Summary (Sticky) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg border border-gray-200 p-6 sticky top-20">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Resumo</h3>
                <div id="summary-content" class="space-y-2 text-sm">
                    {% include "partials/cotacao_summary.html" %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

